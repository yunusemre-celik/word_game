<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Fingers: Precision Edition</title>
    <style>
        /* --- CORE STYLES --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            overflow: hidden;
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 900px;
            height: 650px;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            border: 4px solid #333;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            background: #000;
            overflow: hidden;
        }

        canvas {
            display: block;
            transition: filter 0.3s ease;
        }

        /* Blur Effect Class */
        .blur-effect {
            filter: blur(8px);
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 0px #000;
        }

        .stat-box {
            padding: 5px 10px;
            border-radius: 4px;
        }

        .heart {
            display: inline-block;
            margin-right: 5px;
            font-size: 24px;
            transition: transform 0.2s;
        }
        .heart.lost {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        /* --- INPUT AREA --- */
        #input-area {
            margin-top: 20px;
            width: 900px;
            display: flex;
            justify-content: center;
            position: relative;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 28px;
            background-color: #111;
            color: #fff; /* Default text color */
            border: 2px solid #444;
            border-radius: 8px;
            outline: none;
            text-align: center;
            font-family: inherit;
            text-transform: lowercase;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        /* Dynamic Input Border based on Theme handled in JS */
        input[type="text"]:focus {
            background-color: #222;
        }

        /* --- SCREENS --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            text-align: center;
        }
        .hidden { display: none !important; }

        h1 { font-size: 48px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; }
        h2 { font-size: 32px; margin-bottom: 20px; color: #ffd700; }
        p { font-size: 18px; color: #bbb; margin: 5px 0; max-width: 600px; line-height: 1.5; }

        .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; min-width: 200px; }
        .btn-group-row { display: flex; gap: 20px; margin-top: 20px; }

        button {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            background: transparent;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            font-family: inherit;
            text-transform: uppercase;
        }
        button:hover {
            background: white;
            color: black;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        /* Settings Grid */
        .settings-container {
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            width: 400px;
        }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .control-row label { width: 80px; text-align: left; font-weight: bold; color: #ccc; }
        .control-row input[type=range] { flex: 1; margin: 0 15px; cursor: pointer; }
        .control-row .val-display { width: 50px; text-align: right; font-size: 14px; color: #ffd700; }
        .mute-box { margin-left: 15px; display: flex; align-items: center; gap: 5px; font-size: 12px; color: #888; }
        .mute-box input { cursor: pointer; width: 16px; height: 16px; }

        /* File Upload */
        .file-upload-wrapper { margin-top: 15px; border: 1px dashed #666; padding: 10px; border-radius: 5px; }
        input[type="file"] { display: none; }
        .custom-file-upload { border: 1px solid #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; font-size: 14px; margin-top: 5px; }
        select { padding: 10px; font-size: 16px; background: #222; color: white; border: 1px solid #555; margin-top: 10px; cursor: pointer; }

        /* --- THEME STYLES --- */
        .theme-matrix h1 { color: #0f0; text-shadow: 0 0 10px #0f0; }
        .theme-matrix button { border-color: #0f0; color: #0f0; }
        .theme-matrix button:hover { background: #0f0; color: #000; }
        
        .theme-neon h1 { color: #f0f; text-shadow: 2px 2px #0ff; }
        .theme-neon button { border-color: #0ff; color: #0ff; }
        .theme-neon button:hover { background: #0ff; color: #000; box-shadow: 0 0 20px #0ff; }

        .theme-space h1 { color: #fff; text-shadow: 0 0 15px #fff; }
        .theme-space button { border-color: #fc0; color: #fc0; }
        .theme-space button:hover { background: #fc0; color: #000; }

        .highlight { font-weight: bold; font-size: 1.2em; }

        #countdownOverlay { background: rgba(0,0,0,0.3); pointer-events: none; }
        #countdownText {
            font-size: 120px; font-weight: bold; color: white;
            text-shadow: 0 0 20px rgba(255,255,255,0.8);
            animation: pulse 0.5s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="bgCanvas" width="900" height="650" style="position: absolute; z-index: 0;"></canvas>
            <canvas id="gameCanvas" width="900" height="650" style="position: absolute; z-index: 1;"></canvas>
            
            <div id="ui-layer">
                <div class="stat-box">LEVEL: <span id="levelVal">1</span></div>
                <div class="stat-box">REMAINING: <span id="remainingVal">10</span></div>
                <div class="stat-box">SCORE: <span id="scoreVal">0</span></div>
                <div class="stat-box" id="heart-container">
                    <span id="heart1" class="heart">‚ù§Ô∏è</span>
                    <span id="heart2" class="heart">‚ù§Ô∏è</span>
                    <span id="heart3" class="heart">‚ù§Ô∏è</span>
                </div>
                <div class="stat-box" style="font-size: 14px; opacity: 0.7;">[ESC] PAUSE</div>
            </div>

            <div id="startScreen" class="overlay">
                <h1>Fast Fingers</h1>
                <p>Type correctly to lock on target.</p>
                <div style="margin-top: 20px; text-align: left;">
                    <label>Select Theme:</label><br>
                    <select id="themeSelector">
                        <option value="matrix">Matrix (Hacker)</option>
                        <option value="neon">Neon (Synthwave)</option>
                        <option value="space">Deep Space</option>
                    </select>
                </div>
                <div class="file-upload-wrapper">
                    <p style="font-size: 14px; margin:0;">Optional: Use your own words (.txt)</p>
                    <label for="file-upload" class="custom-file-upload">Upload Custom List</label>
                    <input id="file-upload" type="file" accept=".txt"/>
                    <div id="file-name" style="font-size: 12px; color: #888; margin-top: 5px;"></div>
                </div>
                <button onclick="startGame()" style="margin-top: 30px; font-size: 24px;">START GAME</button>
            </div>

            <div id="pauseScreen" class="overlay hidden">
                <h1>PAUSED</h1>
                <div class="btn-group">
                    <button onclick="resumeGame()">RESUME</button>
                    <button onclick="restartGame()">RESTART</button>
                    <button onclick="toggleSettings(true)">SETTINGS</button>
                    <button onclick="toggleAbout(true)">ABOUT</button>
                    <button onclick="goToMainMenu()">MAIN MENU</button>
                </div>
            </div>

            <div id="settingsScreen" class="overlay hidden">
                <h2>SETTINGS</h2>
                <div class="settings-container">
                    <div class="control-row">
                        <label>MUSIC</label>
                        <input type="range" id="musicSlider" min="0" max="100" value="50">
                        <span id="musicVal" class="val-display">50%</span>
                        <div class="mute-box"><input type="checkbox" id="musicMute"> MUTE</div>
                    </div>
                    <div class="control-row">
                        <label>SFX</label>
                        <input type="range" id="sfxSlider" min="0" max="100" value="50">
                        <span id="sfxVal" class="val-display">50%</span>
                        <div class="mute-box"><input type="checkbox" id="sfxMute"> MUTE</div>
                    </div>
                </div>
                <button onclick="toggleSettings(false)" style="margin-top: 30px;">BACK</button>
            </div>

            <div id="aboutScreen" class="overlay hidden">
                <h2>ABOUT</h2>
                <p>Improve your typing speed and reflexes.</p>
                <br>
                <p>Developed by <span style="color: #00ff00; font-weight: bold;">hirtzirt</span></p>
                <p style="font-size: 14px; color: #888;">(Powered by AI)</p>
                <button onclick="toggleAbout(false)" style="margin-top: 20px;">BACK</button>
            </div>

            <div id="countdownOverlay" class="overlay hidden">
                <div id="countdownText">3</div>
            </div>

            <div id="levelScreen" class="overlay hidden">
                <h2>LEVEL COMPLETE!</h2>
                <p>Correct words this round: <span id="levelCorrectVal" class="highlight">0</span></p>
                <p>Next round target: <span id="nextTotalVal" class="highlight">0</span></p>
                <button onclick="nextLevel()">CONTINUE</button>
            </div>

            <div id="gameOverScreen" class="overlay hidden">
                <h1 style="color: red;">GAME OVER</h1>
                <p>Level Reached: <span id="finalLevel">1</span></p>
                <p>Final Score: <span id="finalScore">0</span></p>
                <div class="btn-group-row">
                    <button onclick="restartGame()">TRY AGAIN</button>
                    <button onclick="goToMainMenu()">MENU</button>
                </div>
            </div>
        </div>
    </div>

    <div id="input-area">
        <input type="text" id="wordInput" placeholder="Type..." autocomplete="off">
    </div>

    <script>
        // --- 0. AUDIO ENGINE ---
        const Sound = {
            ctx: null, musicGain: null, sfxGain: null, bgmFilter: null,
            musicVol: 0.5, sfxVol: 0.5, isMusicMuted: false, isSfxMuted: false,
            isMusicPlaying: false, musicInterval: null,

            init: function() {
                if (!this.ctx) {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    this.musicGain = this.ctx.createGain();
                    this.sfxGain = this.ctx.createGain();
                    this.musicGain.connect(this.ctx.destination);
                    this.sfxGain.connect(this.ctx.destination);
                    this.updateVolumes();
                    this.bgmFilter = this.ctx.createBiquadFilter();
                    this.bgmFilter.type = 'lowpass';
                    this.bgmFilter.frequency.value = 22000;
                    this.bgmFilter.connect(this.musicGain);
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            updateVolumes: function() {
                if(!this.ctx) return;
                this.musicGain.gain.setValueAtTime(this.isMusicMuted?0:this.musicVol, this.ctx.currentTime);
                this.sfxGain.gain.setValueAtTime(this.isSfxMuted?0:this.sfxVol, this.ctx.currentTime);
            },
            setMusicVolume: function(val) { this.musicVol = val; this.updateVolumes(); },
            setSfxVolume: function(val) { this.sfxVol = val; this.updateVolumes(); },
            setMusicMute: function(bool) { this.isMusicMuted = bool; this.updateVolumes(); },
            setSfxMute: function(bool) { this.isSfxMuted = bool; this.updateVolumes(); },

            playTone: function(freq, type, duration, volMultiplier = 1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(1 * volMultiplier, this.ctx.currentTime + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.sfxGain);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            
            click: function() { this.playTone(800, 'sine', 0.1, 0.4); },
            success: function() { 
                if(!this.ctx) return;
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(440, now);
                osc.frequency.exponentialRampToValueAtTime(880, now + 0.2);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + 0.05);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.connect(gain); gain.connect(this.sfxGain);
                osc.start(); osc.stop(now + 0.3);
            },
            error: function() { this.playTone(150, 'sawtooth', 0.2, 0.2); },
            damage: function() { 
                if(!this.ctx) return;
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.6, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.connect(gain); gain.connect(this.sfxGain);
                osc.start(); osc.stop(now + 0.5);
            },
            testBeep: function() { this.playTone(500, 'sine', 0.2, 0.6); },
            countdown: function(num) {
                if (num > 0) this.playTone(600, 'sine', 0.1, 0.4); 
                else this.playTone(1000, 'sine', 0.6, 0.5);
            },
            levelComplete: function() {
                const notes = [440, 554.37, 659.25, 880]; 
                let time = this.ctx.currentTime;
                notes.forEach((note, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine'; osc.frequency.value = note;
                    gain.gain.setValueAtTime(0, time + i*0.15);
                    gain.gain.linearRampToValueAtTime(0.3, time + i*0.15 + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.01, time + i*0.15 + 0.6);
                    osc.connect(gain); gain.connect(this.sfxGain);
                    osc.start(time + i*0.15); osc.stop(time + i*0.15 + 0.6);
                });
            },

            startMusic: function() { if(this.isMusicPlaying || !this.ctx) return; this.isMusicPlaying = true; this.playMusicLoop(); },
            playMusicLoop: function() {
                if(!this.isMusicPlaying) return;
                this.playPad();
                this.musicInterval = setInterval(() => { if(this.isMusicPlaying) this.playPad(); }, 4000); 
            },
            playPad: function() {
                if (!this.ctx) return;
                const baseFreqs = [[220, 329.63, 164.81], [174.61, 261.63, 130.81]];
                const chord = baseFreqs[Math.floor(Math.random() * baseFreqs.length)];
                const now = this.ctx.currentTime;
                chord.forEach(freq => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine'; osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.15, now + 2); 
                    gain.gain.linearRampToValueAtTime(0, now + 4); 
                    osc.connect(gain); gain.connect(this.bgmFilter); 
                    osc.start(); osc.stop(now + 4.1);
                });
            },
            stopMusic: function() { this.isMusicPlaying = false; clearInterval(this.musicInterval); },
            setPauseFilter: function(isPaused) {
                if(!this.bgmFilter) return;
                const freq = isPaused ? 400 : 22000;
                this.bgmFilter.frequency.setTargetAtTime(freq, this.ctx.currentTime, 0.5);
            }
        };

        // --- 1. DATA ---
        const defaultRawWords = {
            3: "cat, dog, sun, man, pen, car, sky, run, fly, box, cup, hat, map, bed, sea, red, big, low, new, old, far, hit, win, try, get, fix, bag, log, pig, cow, bee, toy, hot, lap, tap, lip, rip, hop, pop, bad, sad, fun, war, jar, bar, fan, van, pot, rot, cut, put, fit, dim, him, her, you, she, tie, lie, die, jog, fog, rod, cod, nod, pad, lad, mad, rag, tag, sag, rim, arm, leg, toe, hip, pie, ice, ink, aim, sum, joy, jet, bus, but, dry, cry, sky, why, how, now, zoo, law, raw, saw, paw, maw",
            4: "time, word, love, door, fire, wind, rain, snow, star, moon, blue, read, book, cook, work, play, game, park, tree, wolf, bear, lion, fish, bird, frog, lamp, desk, room, home, dark, kind, soft, hard, move, jump, swim, walk, talk, make, take, give, grow, live, open, shut, hope, fear, pain, gain, loss, cool, warm, cold, high, low, long, wide, thin, near, afar, fall, stay, push, pull, send, keep, rest, stop, ship, boat, plan, idea, fact, view, rate, able, fact, mile, road, path, farm, city, town, king, queen, hero, epic, myth, gold, iron, wood, sand, rock, wave, leaf",
            5: "apple, table, chair, birdy, mouse, house, river, ocean, earth, world, plant, green, black, white, bread, drink, sugar, honey, party, music, sound, light, night, dream, sleep, think, judge, learn, teach, watch, paint, write, build, break, carry, drive, climb, dance, smile, laugh, happy, angry, crazy, magic, power, cloud, storm, water, flame, stone, solid, shape, space, speed, trace, wider, close, other, maybe, after, first, third, point, place, heart, brain, faith, truth, earth, world, small, large, basic, final, sweet, rough, sharp, clean, dirty, young, older, world, trust, score, event, force, legal",
            6: "animal, planet, forest, desert, castle, camera, driver, writer, reader, button, rhythm, orange, yellow, purple, people, nature, system, winter, summer, autumn, spring, beauty, wonder, figure, circle, square, doctor, school, future, family, memory, travel, create, design, choose, repeat, return, follow, forget, believe, rescue, attack, broken, silver, golden, matter, energy, fabric, motion, window, pillow, mother, father, sister, friend, battle, weapon, random, simple, bright, shadow, secret, hidden, chosen, mighty, packet, market, ticket, lesson, fabric, remote, laptop, annual, global, native, lovely, silent, noisy, charge, keeper, hunter, singer, driver, vendor, painter, author",
            7: "freedom, history, science, fantasy, mystery, problem, project, digital, network, engineer, awesome, courage, village, kingdom, captain, monster, library, station, printer, battery, running, walking, sleeping, growing, teacher, student, charity, finance, gateway, highway, journey, natural, organic, magnetic, plastic, crystal, clarity, thunder, tornado, volcano, gravity, balance, believe, imagine, warrior, soldier, guardian, message, display, monitor, creator, explorer, cyclone, horizon, miracle, fortune, justice, diamond, emerald, sapphire, primary, central, outside, inside, between, forward, ancient, perfect, musical, airport, bedroom, kitchen, program, restart, upgrade, project, storage, channel, speaker, charger, uniform, venture, package, imagine, context, victory",
            8: "anything, strength, mountain, building, educator, engineer, designer, composer, operator, freezing, shining, density, mobility, security, protocol, platform, software, hardware, notebook, dinosaur, creation, reaction, adoption, delivery, activity, priority, mobility, elephant, festival, identity, prophecy, alliances, starlight, universe, infinity, sunlight, notebook, backpack, wildfire, overlook, basement, waterfall, pressure, alliance, boundary, category, calendar, contrast, defender, behavior, velocity, research, approval, notebook, merchant, observer, printing, training, visitor, warrior, scenario, mobility, organism, director, producer, elevator, hospital, medicine, cultural, valuable, powerful, priceless, daughter, birthday, homeland",
            9: "character, advantage, adventure, vertebrae, astronaut, hurricane, dangerous, elevation, wallpaper, brainstorm, strawberry, blueberry, chocolate, fantastic, brilliant, lightning, recording, character, trademark, alignment, impressed, microwave, accelerate, satisfied, discovery, overnight, sensation, animation, broadcasting, celebration, classroom, practical, activated, universal, meditation, elevator, spacecraft, generator, container, windshield, signature, adventure, challenged, confident, dangerous, detective, judgement, operation, vibration, direction, effective, identical, objective, residence, creature, waterfall, fairyland, timeline, dangerous, something, evermore, underworld, situation, landscape, motivated, transport, unlimited, impressed",
            10: "motivation, reflection, foundation, generation, elevation, innovation, inspiration, television, expression, attraction, scientist, contractor, technician, algorithms, spacecraft, smartphone, hologramic, controller, simulation, everlasting, meditation, protective, structural, navigation, historical, humanities, activation, arrangement, dangerous, connection, definition, occupation, perfection, background, earthquake, flashlight, multimedia, projection, personality, exploration, independence, translator, dictionary, graduation, artificial, automation, horizontal, celebration, legendary, everlasting, borderline, processing, vegetation, importance, invitation, separation, resolution, improvement, playground, observation, negotiation",
            11: "imagination, environment, construction, application, celebration, observation, explanation, independence, relationship, championship, presentation, illustration, transformation, acceleration, integration, architecture, brainstorming, conversation, distribution, development, announcement, organization, alternatives, contribution, satisfaction, verification, professional, modification, participation, continuation, visualization, misunderstanding, transportation, qualification, determination, international, documentation, collaboration, confidentiality, recommendation, representation, compatibility, revolutionary, overwhelming, understanding, responsibility, consciousness, contradiction, preservation",
            12: "communication, consideration, manufacturing, representation, implementation, transportation, transformation, contradiction, misunderstanding, interstellar, technological, administration, configuration, rehabilitation, investigation, extraordinary, recommendation, qualification, meteorologist, environmental, reconstruction, entertainment, certification, authentication, transcription, synchronization, electromagnetic, revolutionary, modernization, participation, determination, responsibility, international, improvisation, infrastructure, identification, concentration, documentation, collaboration"
        };

        let activeWordDB = {};
        let useCustomList = false;
        let customWordList = [];

        function parseWordDB(rawData) {
            let db = {};
            for(let key in rawData) db[key] = rawData[key].split(',').map(w => w.trim()).filter(w => w.length > 0);
            return db;
        }
        activeWordDB = parseWordDB(defaultRawWords);

        // --- 2. THEMES ---
        const themes = {
            matrix: {
                bg: '#000000', textPrimary: '#00ff00', 
                wordColors: (len) => '#ffffff', highlight: '#00ff00', 
                glow: '#00ff00', particle: ['#0f0', '#afa', '#fff'], font: 'Courier New', bgOpacity: 0.15 
            },
            neon: {
                bg: '#1a0029', textPrimary: '#00ffff',
                wordColors: (len) => '#aaaaaa', highlight: '#00ffff',
                glow: 'transparent', particle: ['#f0f', '#0ff', '#ff0'], font: 'Verdana', bgOpacity: 1.0
            },
            space: {
                bg: '#050510', textPrimary: '#ffffff',
                wordColors: (len) => '#888888', highlight: '#ffcc00',
                glow: 'transparent', particle: ['#fff', '#fc0', '#aaa'], font: 'Arial', bgOpacity: 1.0
            }
        };
        let currentTheme = 'matrix';

        // --- 3. GAME STATE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const inputField = document.getElementById('wordInput');
        const container = document.getElementById('game-container');

        let gameState = 'START'; 
        let level = 1, score = 0, lives = 3;
        let targetWordsTotal = 10, wordsSpawned = 0, correctWordsInLevel = 0;
        let spawnRate = 2000, lastSpawnTime = 0;
        
        let activeWords = [];
        let particles = [];
        let shakeDuration = 0;
        let countdownValue = 3;
        
        // NEW: Typed Buffer
        let typedString = ""; 

        // --- 4. ENGINE ---
        function init() {
            document.getElementById('themeSelector').addEventListener('change', (e) => setTheme(e.target.value));
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            
            // Settings Listeners
            document.getElementById('musicSlider').addEventListener('input', (e) => {
                document.getElementById('musicVal').innerText = e.target.value + "%"; Sound.init(); Sound.setMusicVolume(e.target.value/100);
            });
            document.getElementById('musicMute').addEventListener('change', (e) => { Sound.init(); Sound.setMusicMute(e.target.checked); });
            document.getElementById('sfxSlider').addEventListener('input', (e) => {
                document.getElementById('sfxVal').innerText = e.target.value + "%"; Sound.init(); Sound.setSfxVolume(e.target.value/100); Sound.testBeep();
            });
            document.getElementById('sfxMute').addEventListener('change', (e) => { Sound.init(); Sound.setSfxMute(e.target.checked); });

            document.addEventListener('keydown', (e) => {
                if(e.key === "Escape") handleEscKey();
            });

            // CUSTOM INPUT HANDLER
            inputField.addEventListener('keydown', handleTyping);
            // Prevent pasting
            inputField.addEventListener('paste', (e) => e.preventDefault());

            setTheme('matrix');
            bgLoop();
            updateHeartsUI();
        }

        function setTheme(themeName) {
            currentTheme = themeName;
            document.body.className = `theme-${themeName}`;
            inputField.style.borderColor = themes[themeName].textPrimary;
            if (themeName === 'matrix') initMatrix();
            if (themeName === 'space') initSpace();
        }

        function handleEscKey() {
            if (gameState === 'PLAYING') pauseGame();
            else if (gameState === 'PAUSED') resumeGame();
            else if (gameState === 'ABOUT') toggleAbout(false);
            else if (gameState === 'SETTINGS') toggleSettings(false);
        }

        // --- TYPING MECHANIC (LOCK-ON SYSTEM) ---
        function handleTyping(e) {
            if (gameState !== 'PLAYING') {
                e.preventDefault();
                return;
            }

            // Allow only letters and Backspace
            if (e.key === 'Backspace') {
                e.preventDefault();
                typedString = typedString.slice(0, -1);
                inputField.value = typedString;
                return;
            }

            if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
                e.preventDefault(); // Stop default insertion
                const char = e.key.toLowerCase();
                const attempt = typedString + char;

                // Check if this attempt matches the start of ANY active word
                const matches = activeWords.filter(w => w.text.startsWith(attempt));

                if (matches.length > 0) {
                    // Valid Input
                    typedString = attempt;
                    inputField.value = typedString;
                    Sound.click();

                    // Check for Full Match
                    const exactMatchIndex = activeWords.findIndex(w => w.text === typedString);
                    if (exactMatchIndex !== -1) {
                        // Word Completed!
                        const word = activeWords[exactMatchIndex];
                        Sound.success();
                        createExplosion(word.x + (ctx.measureText(word.text).width/2), word.y);
                        
                        activeWords.splice(exactMatchIndex, 1);
                        score += word.text.length * 10;
                        correctWordsInLevel++;
                        
                        // Reset Buffer
                        typedString = "";
                        inputField.value = "";
                        
                        // Feedback
                        inputField.style.borderColor = themes[currentTheme].textPrimary;
                        setTimeout(() => inputField.style.borderColor = "#444", 100);
                        updateUI();
                    }

                } else {
                    // Invalid Input -> Shake & Error
                    shakeScreen(5);
                    Sound.error();
                    inputField.style.borderColor = "red";
                    setTimeout(() => inputField.style.borderColor = "#444", 100);
                }
            } else {
                e.preventDefault(); // Block other keys
            }
        }

        // --- GAME CONTROL ---
        function startGame() {
            Sound.init(); Sound.startMusic(); Sound.setPauseFilter(false); 
            level = 1; score = 0; lives = 3; targetWordsTotal = 10;
            resetLevelVars(); updateUI();
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            inputField.disabled = false; inputField.focus();
            gameState = 'PLAYING';
            gameLoop(0);
        }

        function restartGame() { unpauseUI(); startGame(); }
        function pauseGame() {
            gameState = 'PAUSED'; Sound.setPauseFilter(true); 
            document.getElementById('gameCanvas').classList.add('blur-effect');
            document.getElementById('bgCanvas').classList.add('blur-effect');
            document.getElementById('pauseScreen').classList.remove('hidden');
            inputField.disabled = true;
        }
        function resumeGame() { document.getElementById('pauseScreen').classList.add('hidden'); startCountdown(); }
        function unpauseUI() {
            Sound.setPauseFilter(false); 
            document.getElementById('gameCanvas').classList.remove('blur-effect');
            document.getElementById('bgCanvas').classList.remove('blur-effect');
            inputField.disabled = false; inputField.focus();
        }
        function goToMainMenu() {
            gameState = 'START'; Sound.stopMusic(); unpauseUI();
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            document.getElementById('startScreen').classList.remove('hidden');
        }
        function startCountdown() {
            gameState = 'COUNTDOWN'; countdownValue = 3;
            document.getElementById('countdownOverlay').classList.remove('hidden');
            updateCountdownDisplay(); Sound.countdown(3);
            let timer = setInterval(() => {
                countdownValue--;
                if(countdownValue <= 0) {
                    Sound.countdown(0); clearInterval(timer);
                    document.getElementById('countdownOverlay').classList.add('hidden');
                    unpauseUI(); gameState = 'PLAYING';
                    lastSpawnTime = performance.now(); gameLoop(performance.now());
                } else {
                    Sound.countdown(countdownValue); updateCountdownDisplay();
                }
            }, 1000);
        }
        function updateCountdownDisplay() { document.getElementById('countdownText').innerText = countdownValue; }
        function resetLevelVars() {
            wordsSpawned = 0; correctWordsInLevel = 0;
            activeWords = []; particles = [];
            typedString = ""; inputField.value = ""; // Reset Buffer
            lastSpawnTime = 0;
            spawnRate = Math.max(800, 2000 - (level * 100)); 
            document.getElementById('remainingVal').innerText = targetWordsTotal;
        }
        function nextLevel() {
            targetWordsTotal = targetWordsTotal + correctWordsInLevel; level++;
            resetLevelVars();
            document.getElementById('levelScreen').classList.add('hidden');
            startCountdown(); 
        }

        // --- GAME LOOP ---
        function gameLoop(timestamp) {
            if (gameState !== 'PLAYING') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Spawn
            if (wordsSpawned < targetWordsTotal) {
                if (timestamp - lastSpawnTime > spawnRate) {
                    spawnWord();
                    lastSpawnTime = timestamp;
                    document.getElementById('remainingVal').innerText = targetWordsTotal - correctWordsInLevel;
                }
            } else if (activeWords.length === 0 && particles.length === 0) {
                endLevel(); return;
            }

            // Draw Words (Highlighter Logic)
            for (let i = activeWords.length - 1; i >= 0; i--) {
                let w = activeWords[i];
                w.y += w.speed;

                ctx.font = `bold 24px ${themes[currentTheme].font}`;
                const text = w.text;
                
                // Highlight Logic
                if (text.startsWith(typedString)) {
                    // Draw Matched Part
                    const matchedPart = typedString;
                    const remainingPart = text.substring(typedString.length);
                    
                    ctx.fillStyle = themes[currentTheme].highlight;
                    if(themes[currentTheme].glow !== 'transparent') {
                         ctx.shadowColor = themes[currentTheme].glow; ctx.shadowBlur = 15;
                    }
                    ctx.fillText(matchedPart, w.x, w.y);
                    ctx.shadowBlur = 0; // Reset glow for remainder

                    // Draw Remaining Part
                    const matchedWidth = ctx.measureText(matchedPart).width;
                    ctx.fillStyle = themes[currentTheme].wordColors(text.length); // Dim color
                    ctx.fillText(remainingPart, w.x + matchedWidth, w.y);

                } else {
                    // Normal Draw (Unmatched)
                    ctx.fillStyle = themes[currentTheme].wordColors(text.length);
                    ctx.fillText(text, w.x, w.y);
                }

                if (w.y > canvas.height) {
                    loseLife();
                    activeWords.splice(i, 1);
                    shakeScreen(10);
                    // If the lost word was being typed, reset buffer
                    if (w.text.startsWith(typedString)) {
                        typedString = ""; inputField.value = "";
                    }
                }
            }

            updateParticles();
            handleShake();
            requestAnimationFrame(gameLoop);
        }

        function spawnWord() {
            let text = "";
            if (useCustomList && customWordList.length > 0) {
                text = customWordList[Math.floor(Math.random() * customWordList.length)];
            } else {
                let minLen = 3, maxLen = 12;
                if (level <= 3) maxLen = 5;
                else if (level <= 6) { minLen = 6; maxLen = 8; }
                let validLengths = Object.keys(activeWordDB).filter(k => k >= minLen && k <= maxLen);
                if (validLengths.length === 0) validLengths = Object.keys(activeWordDB);
                let chosenLen = validLengths[Math.floor(Math.random() * validLengths.length)];
                text = activeWordDB[chosenLen][Math.floor(Math.random() * activeWordDB[chosenLen].length)];
            }
            activeWords.push({
                text: text,
                x: Math.random() * (canvas.width - 150) + 20,
                y: -30,
                color: themes[currentTheme].wordColors(text.length),
                speed: 1 + (level * 0.15) + (text.length * 0.05)
            });
            wordsSpawned++;
        }

        function updateUI() {
            document.getElementById('scoreVal').innerText = score; updateHeartsUI();
            document.getElementById('levelVal').innerText = level;
            document.getElementById('remainingVal').innerText = targetWordsTotal - correctWordsInLevel;
        }
        function updateHeartsUI() {
            for(let i=1; i<=3; i++) {
                const h = document.getElementById('heart' + i);
                if (i <= lives) { h.innerText = "‚ù§Ô∏è"; h.classList.remove('lost'); }
                else { h.innerText = "üñ§"; h.classList.add('lost'); }
            }
        }
        function loseLife() {
            Sound.damage();
            const h = document.getElementById('heart' + lives);
            if(h) {
                const r = h.getBoundingClientRect(); const cr = container.getBoundingClientRect();
                createExplosion(r.left - cr.left + 15, r.top - cr.top + 15);
            }
            lives--; updateUI();
            if (lives <= 0) {
                gameState = 'GAME_OVER'; Sound.stopMusic(); inputField.disabled = true;
                document.getElementById('finalScore').innerText = score;
                document.getElementById('finalLevel').innerText = level;
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
        }
        function endLevel() {
            gameState = 'LEVEL_END'; Sound.levelComplete(); inputField.disabled = true;
            document.getElementById('levelCorrectVal').innerText = correctWordsInLevel;
            document.getElementById('nextTotalVal').innerText = targetWordsTotal + correctWordsInLevel;
            document.getElementById('levelScreen').classList.remove('hidden');
        }

        function shakeScreen(frames) { shakeDuration = frames; }
        function handleShake() {
            if (shakeDuration > 0) {
                container.style.transform = `translate(${(Math.random()-0.5)*10}px, ${(Math.random()-0.5)*10}px)`;
                shakeDuration--;
            } else { container.style.transform = "none"; }
        }
        function createExplosion(x, y) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x, y: y, vx: (Math.random() - 0.5) * 5, vy: (Math.random() - 0.5) * 5,
                    life: 1.0, color: themes[currentTheme].particle[Math.floor(Math.random()*themes[currentTheme].particle.length)]
                });
            }
        }
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
                else {
                    ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0;
                }
            }
        }

        // --- BGS ---
        let matrixDrops = []; let stars = [];
        function initMatrix() { matrixDrops = Array(Math.ceil(bgCanvas.width/16)).fill(1); }
        function initSpace() { stars = []; for(let i=0;i<100;i++) stars.push({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,size:Math.random()*2,speed:Math.random()*0.5+0.1}); }
        function bgLoop() {
            if (currentTheme === 'matrix') {
                bgCtx.fillStyle = `rgba(0,0,0,0.05)`; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
                bgCtx.fillStyle = `rgba(0,255,0,${themes.matrix.bgOpacity})`; bgCtx.font = '16px monospace';
                matrixDrops.forEach((y, i) => {
                    bgCtx.fillText(String.fromCharCode(0x30A0+Math.random()*96), i*16, y*16);
                    if(y*16>bgCanvas.height && Math.random()>0.975) matrixDrops[i]=0; matrixDrops[i]++;
                });
            } else if (currentTheme === 'neon') {
                bgCtx.fillStyle = '#1a0029'; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
                bgCtx.strokeStyle = 'rgba(255,0,255,0.2)';
                let offset = (Date.now()%1000)/1000*50;
                for(let y=0; y<bgCanvas.height; y+=50) { bgCtx.beginPath(); bgCtx.moveTo(0, y+offset); bgCtx.lineTo(bgCanvas.width, y+offset); bgCtx.stroke(); }
                for(let x=0; x<bgCanvas.width; x+=50) { bgCtx.beginPath(); bgCtx.moveTo(x, 0); bgCtx.lineTo(x, bgCanvas.height); bgCtx.stroke(); }
            } else if (currentTheme === 'space') {
                bgCtx.fillStyle = '#050510'; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
                bgCtx.fillStyle = 'white';
                stars.forEach(s => {
                    bgCtx.fillRect(s.x, s.y, s.size, s.size); s.y += s.speed;
                    if(s.y > bgCanvas.height) s.y = 0;
                });
            }
            requestAnimationFrame(bgLoop);
        }

        function toggleAbout(show) { gameState=show?'ABOUT':'PAUSED'; show? (document.getElementById('pauseScreen').classList.add('hidden'),document.getElementById('aboutScreen').classList.remove('hidden')):(document.getElementById('aboutScreen').classList.add('hidden'),document.getElementById('pauseScreen').classList.remove('hidden')); }
        function toggleSettings(show) { gameState=show?'SETTINGS':'PAUSED'; show? (document.getElementById('pauseScreen').classList.add('hidden'),document.getElementById('settingsScreen').classList.remove('hidden')):(document.getElementById('settingsScreen').classList.add('hidden'),document.getElementById('pauseScreen').classList.remove('hidden')); }
        function handleFileUpload(e) {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader(); r.onload=function(e){
                const w = e.target.result.split(/[\s,]+/).map(w=>w.trim()).filter(w=>w.length>=3&&w.length<=12);
                if(w.length>0){customWordList=w;useCustomList=true;document.getElementById('file-name').innerText=`Loaded: ${f.name}`;document.getElementById('file-name').style.color="#0f0";}else alert("No valid words.");
            }; r.readAsText(f);
        }
        init();
    </script>
</body>
</html>